{% extends 'amsApp/base.html' %} {% block content %}
<div class="content-wrapper">
	<!-- Content Header (Page header) -->
	<div class="content-header">
		<div class="container-fluid">
			<div class="row mb-2">
				<div class="col-sm-6">
					<h1 class="m-0">Dashboard</h1>
				</div>
				<!-- /.col -->
				<div class="col-sm-6">
					<ol class="breadcrumb float-sm-right">
						<li class="breadcrumb-item"><a href="#">Home</a></li>
						<li class="breadcrumb-item active">Dashboard v1</li>
					</ol>
				</div>
				<!-- /.col -->
			</div>
			<!-- /.row -->
		</div>
		<!-- /.container-fluid -->
	</div>
	<!-- /.content-header -->

	<!-- Main content -->
	<section class="content">
		<div class="container-fluid">
			<div class="row">
				<div class="col-12">
					<form class="form-inline float-right">
						<div class="form-group mb-2 mr-2">
							<label for="start_date" class="mr-2">Start Date:</label>
							<input type="date" id="start_date" class="form-control" />
						</div>
						<div class="form-group mb-2 mr-2">
							<label for="end_date" class="mr-2">End Date:</label>
							<input type="date" id="end_date" class="form-control" />
						</div>
						<div class="form-group mb-2">
							<button id="fetchDashBtn" type="button" class="btn btn-info">
								Fetch
							</button>
						</div>
					</form>
				</div>
			</div>

			<!-- Small boxes (Stat box) -->
			<div class="row">
				<div class="col-lg-3 col-6">
					<!-- small box -->
					<div class="small-box bg-info">
						<div class="inner">
							<h3 id="tol-reg-emp">0</h3>

							<p>Total Registered Employee</p>
						</div>
						<div class="icon">
							<i class="ion ion-person-add"></i>
						</div>
						<a href="#" class="small-box-footer"
							>More info <i class="fas fa-arrow-circle-right"></i
						></a>
					</div>
				</div>
				<!-- ./col -->
				<div class="col-lg-3 col-6">
					<!-- small box -->
					<div class="small-box bg-success">
						<div class="inner">
							<h3 id="total-presents">0</h3>

							<p>Total Presents (All Events)</p>
						</div>
						<div class="icon">
							<i class="ion ion-stats-bars"></i>
						</div>
						<a href="#" class="small-box-footer"
							>More info <i class="fas fa-arrow-circle-right"></i
						></a>
					</div>
				</div>
				<!-- ./col -->
				<div class="col-lg-3 col-6">
					<!-- small box -->
					<div class="small-box bg-warning">
						<div class="inner">
							<h3 id="total-offices">0</h3>

							<p>Total Offices</p>
						</div>
						<div class="icon">
							<i class="ion ion-help-buoy"></i>
						</div>
						<a href="#" class="small-box-footer"
							>More info <i class="fas fa-arrow-circle-right"></i
						></a>
					</div>
				</div>
				<!-- ./col -->
				<div class="col-lg-3 col-6">
					<!-- small box -->
					<div class="small-box bg-danger">
						<div class="inner">
							<h3 id="total-events">0</h3>

							<p>Total Events</p>
						</div>
						<div class="icon">
							<i class="ion ion-pie-graph"></i>
						</div>
						<a href="#" class="small-box-footer"
							>More info <i class="fas fa-arrow-circle-right"></i
						></a>
					</div>
				</div>
				<!-- ./col -->
			</div>
			<!-- End of Info Boxes Row -->

			<!-- /.row -->
			<!-- Main row -->
			<div class="row">
				<section class="col-lg-6 connectedSortable">
					<!-- Custom tabs (Charts with tabs)-->
					<div class="card">
						<div class="card-header">
							<h3 class="card-title">
								<i class="fas fa-chart-pie mr-1"></i>
								Event Partcipation
							</h3>
						</div>
						<!-- /.card-header -->
						<div class="card-body">
							<canvas id="eventParticipationChart"></canvas>
						</div>
						<!-- /.card-body -->
					</div>
					<!-- /.card -->
				</section>

				<section class="col-lg-6 connectedSortable">
					<!-- Custom tabs (Charts with tabs)-->
					<div class="card">
						<div class="card-header">
							<h3 class="card-title">
								<i class="fas fa-map-marker-alt mr-1"></i>
								by Day of Week
							</h3>
						</div>
						<div class="card-body" style="height: 500px">
							<canvas id="punchesByWeekdayChart"></canvas>
						</div>
					</div>
					<!-- /.card -->
				</section>
			</div>

			<div class="row">
				<!-- Left col -->

				<section class="col-lg-6 connectedSortable">
					<!-- Custom tabs (Charts with tabs)-->
					<div class="card">
						<div class="card-header">
							<h3 class="card-title">
								<i class="fas fa-chart-pie mr-1"></i>
								Punch IN
							</h3>
						</div>
						<!-- /.card-header -->
						<div class="card-body">
							<canvas id="attendanceChartIn" height="120"></canvas>
						</div>
						<!-- /.card-body -->
					</div>
					<!-- /.card -->
				</section>
				<!-- /.Left col -->
				<!-- right col-->
				<section class="col-lg-6 connectedSortable">
					<!-- Custom tabs (Charts with tabs)-->
					<div class="card">
						<div class="card-header">
							<h3 class="card-title">
								<i class="fas fa-chart-pie mr-1"></i>
								Punch out
							</h3>
						</div>
						<!-- /.card-header -->
						<div class="card-body">
							<canvas id="attendanceChartOut" height="120"></canvas>
						</div>
						<!-- /.card-body -->
					</div>
					<!-- /.card -->
				</section>
				<!-- right col -->
			</div>
			<!-- /.row (main row) -->

			<div class="row">
				<section class="col-lg-12 connectedSortable">
					<!-- Custom tabs (Charts with tabs)-->
					<div class="card">
						<div class="card-header">
							<h3 class="card-title">
								<i class="fas fa-chart-pie mr-1"></i>
								Attendance Per Office
							</h3>
						</div>
						<!-- /.card-header -->
						<div class="card-body">
							<canvas id="attendanceOfficeChart"></canvas>
						</div>
						<!-- /.card-body -->
					</div>
					<!-- /.card -->
				</section>
			</div>
		</div>
		<!-- /.container-fluid -->
	</section>
	<!-- /.content -->
</div>
{% endblock %}{% block scripts %}
<style>
	#eventParticipationChart {
		height: 400px !important;
		max-height: 400px;
	}
</style>
<script>
	$(document).ready(function () {
		const dataFetch = "{% url 'getDashTotalRecords' %}";
		const attendanceFetch = "{% url 'getDashAttendance' %}";
		const eventParticipationFetch = "{% url 'getDashEventPart' %}"; // <-- Add this line
		const officeAttendanceFetch = "{% url 'getDashOffice' %}";
		const punchesByWeekdayFetch = "{% url 'getDashPunchesByWeekday' %}";

		let attendanceChartIn = null;
		let attendanceChartOut = null;
		let eventParticipationChart = null;
		let attendanceOfficeChart = null;
		let punchesByWeekdayChart = null;

		function fetchDashboardData(startDate, endDate) {
			let url = dataFetch;
			if (startDate && endDate) {
				url += `?start_date=${startDate}&end_date=${endDate}`;
			}
			$.get(url, function (data) {
				$("#tol-reg-emp").text(data.total_registered_employee);
				$("#total-presents").text(data.total_presents);
				$("#total-offices").text(data.total_offices);
				$("#total-events").text(data.total_events);
			}).fail(function () {
				$("#tol-reg-emp, #total-presents, #total-offices, #total-events").text(
					"0"
				);
			});
		}

		function fetchAttendanceData(startDate, endDate) {
			let url = attendanceFetch;
			if (startDate && endDate) {
				url += `?start_date=${startDate}&end_date=${endDate}`;
			}
			$.get(url, function (data) {
				const labels = data.punchTimeIn.map((item) => item.week);
				const punchInCounts = data.punchTimeIn.map((item) => item.count);
				const punchOutCounts = data.punchTimeOut.map((item) => item.count);

				// Punch IN Chart
				const ctxIn = document
					.getElementById("attendanceChartIn")
					.getContext("2d");
				if (
					attendanceChartIn &&
					typeof attendanceChartIn.destroy === "function"
				) {
					attendanceChartIn.destroy();
				}
				attendanceChartIn = new Chart(ctxIn, {
					type: "line",
					data: {
						labels: labels,
						datasets: [
							{
								label: "Punch In",
								data: punchInCounts,
								borderColor: "rgba(54, 162, 235, 1)",
								backgroundColor: "rgba(54, 162, 235, 0.2)",
								fill: true,
								tension: 0.4,
							},
						],
					},
					options: {
						responsive: true,
						plugins: {
							legend: { display: true },
							title: {
								display: true,
								text: "Weekly Punch In",
							},
						},
						scales: {
							x: { title: { display: true, text: "Week" } },
							y: { title: { display: true, text: "Count" }, beginAtZero: true },
						},
					},
				});

				// Punch OUT Chart
				const ctxOut = document
					.getElementById("attendanceChartOut")
					.getContext("2d");
				if (
					attendanceChartOut &&
					typeof attendanceChartOut.destroy === "function"
				) {
					attendanceChartOut.destroy();
				}
				attendanceChartOut = new Chart(ctxOut, {
					type: "line",
					data: {
						labels: labels,
						datasets: [
							{
								label: "Punch Out",
								data: punchOutCounts,
								borderColor: "rgba(255, 99, 132, 1)",
								backgroundColor: "rgba(255, 99, 132, 0.2)",
								fill: true,
								tension: 0.4,
							},
						],
					},
					options: {
						responsive: true,
						plugins: {
							legend: { display: true },
							title: {
								display: true,
								text: "Weekly Punch Out",
							},
						},
						scales: {
							x: { title: { display: true, text: "Week" } },
							y: { title: { display: true, text: "Count" }, beginAtZero: true },
						},
					},
				});
			});
		} // Initial fetch (with no date, fetch all)

		function fetchEventParticipationData(startDate, endDate) {
			let url = eventParticipationFetch;
			if (startDate && endDate) {
				url += `?start_date=${startDate}&end_date=${endDate}`;
			}
			$.get(url, function (data) {
				const labels = data.participation.map((item) => item.eventName);
				const counts = data.participation.map((item) => item.count);

				const ctx = document
					.getElementById("eventParticipationChart")
					.getContext("2d");
				if (
					window.eventParticipationChart &&
					typeof window.eventParticipationChart.destroy === "function"
				) {
					window.eventParticipationChart.destroy();
				}
				window.eventParticipationChart = new Chart(ctx, {
					type: "doughnut",
					data: {
						labels: labels,
						datasets: [
							{
								data: counts,
								backgroundColor: [
									"#36A2EB",
									"#FF6384",
									"#FFCE56",
									"#4BC0C0",
									"#9966FF",
									"#FF9F40",
									"#C9CBCF",
									"#B2FF66",
									"#FF66B2",
									"#66FFB2",
								],
							},
						],
					},
					options: {
						responsive: true,
						maintainAspectRatio: false, // Allow custom height
						plugins: {
							legend: { display: true, position: "bottom" },
							title: {
								display: true,
								text: "Event Participation",
							},
							datalabels: {
								color: "#470303",
								formatter: function (value, context) {
									return context.chart.data.labels[context.dataIndex];
								},
								font: {
									weight: "bold",
									size: 10,
								},
							},
						},
					},
					plugins: [ChartDataLabels],
				});
			});
		}

		function fetchOfficeAttendanceData(startDate, endDate) {
			let url = officeAttendanceFetch;
			if (startDate && endDate) {
				url += `?start_date=${startDate}&end_date=${endDate}`;
			}
			$.get(url, function (data) {
				const labels = data.offices.map((item) => item.office);
				const counts = data.offices.map((item) => item.count);

				// Move dynamic height calculation here
				const rowHeight = 40;
				const minHeight = 400;
				const dynamicHeight = Math.max(
					minHeight,
					data.offices.length * rowHeight
				);
				$("#attendanceOfficeChart").attr("height", dynamicHeight);

				const ctx = document
					.getElementById("attendanceOfficeChart")
					.getContext("2d");
				if (
					attendanceOfficeChart &&
					typeof attendanceOfficeChart.destroy === "function"
				) {
					attendanceOfficeChart.destroy();
				}
				attendanceOfficeChart = new Chart(ctx, {
					type: "bar",
					data: {
						labels: labels,
						datasets: [
							{
								label: "Attendance",
								data: counts,
								backgroundColor: "rgba(54, 162, 235, 0.7)",
								borderColor: "rgba(54, 162, 235, 1)",
								borderWidth: 1,
								barThickness: 20,
								maxBarThickness: 25,
							},
						],
					},
					options: {
						indexAxis: "y",
						responsive: true,
						maintainAspectRatio: false,
						plugins: {
							legend: { display: false },
							title: {
								display: true,
								text: "Attendance Per Office",
							},
							datalabels: {
								anchor: "end",
								align: "right",
								color: "#470303", // <-- Default color for count value
								font: {
									weight: "bold",
									size: 14,
								},
								formatter: function (value) {
									return value;
								},
							},
						},
						scales: {
							x: { title: { display: true, text: "Count" }, beginAtZero: true },
							y: {
								title: { display: true, text: "Office" },
								ticks: {
									font: { size: 12 },
									padding: 10,
									callback: function (value) {
										let label = this.getLabelForValue(value);
										return label.length > 30 ? label.slice(0, 30) + "â€¦" : label;
									},
								},
							},
						},
					},
					plugins: [ChartDataLabels], // <-- Add this line
				});
			});
		}

		function fetchPunchesByWeekdayData(startDate, endDate) {
			let url = punchesByWeekdayFetch;
			if (startDate && endDate) {
				url += `?start_date=${startDate}&end_date=${endDate}`;
			}
			$.get(url, function (data) {
				const labels = data.punches_by_weekday.map((item) => item.weekday);
				const counts = data.punches_by_weekday.map((item) => item.count);

				const ctx = document
					.getElementById("punchesByWeekdayChart")
					.getContext("2d");
				if (
					punchesByWeekdayChart &&
					typeof punchesByWeekdayChart.destroy === "function"
				) {
					punchesByWeekdayChart.destroy();
				}
				punchesByWeekdayChart = new Chart(ctx, {
					type: "bar",
					data: {
						labels: labels,
						datasets: [
							{
								label: "Punches",
								data: counts,
								backgroundColor: "rgba(255, 206, 86, 0.7)",
								borderColor: "rgba(255, 206, 86, 1)",
								borderWidth: 1,
							},
						],
					},
					options: {
						responsive: true,
						plugins: {
							legend: { display: false },
							title: {
								display: true,
								text: "Punches by Day of Week",
							},
						},
						scales: {
							y: { beginAtZero: true },
						},
					},
				});
			});
		}

		fetchDashboardData("", "");
		fetchAttendanceData("", "");
		fetchEventParticipationData("", "");
		fetchOfficeAttendanceData("", "");
		fetchPunchesByWeekdayData("", "");

		// Fetch on button click
		$("#fetchDashBtn").on("click", function (e) {
			e.preventDefault();
			let startDate = $("#start_date").val();
			let endDate = $("#end_date").val();
			fetchDashboardData(startDate, endDate);
			fetchAttendanceData(startDate, endDate);
			fetchEventParticipationData(startDate, endDate);
			fetchOfficeAttendanceData(startDate, endDate);
			fetchPunchesByWeekdayData(startDate, endDate);
		});
	});
</script>
{% endblock %}
